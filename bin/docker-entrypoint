#!/bin/bash -e

# Enable jemalloc for reduced memory usage and latency.
if [ -z "${LD_PRELOAD+x}" ]; then
    LD_PRELOAD=$(find /usr/lib -name libjemalloc.so.2 -print -quit)
    export LD_PRELOAD
fi

# If running the rails server then create, migrate, and seed the database
if [ "${@: -2:1}" == "./bin/rails" ] && [ "${@: -1:1}" == "server" ]; then
  echo "Running database setup (migrate and seed)..."
  
  # Option 1: db:migrate followed by db:seed (Recommended)
  # This ensures migrations run, followed by seeds. Safe for existing DBs.
  ./bin/rails db:migrate
  ./bin/rails db:seed
  
  # OR use db:setup if you prefer (Only safe if you are sure you want to load schema from scratch on first deploy)
  # ./bin/rails db:setup  # db:setup = db:create, db:schema:load, db:seed
  
fi

exec "$@"